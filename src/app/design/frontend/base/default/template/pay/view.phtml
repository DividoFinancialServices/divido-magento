<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     rwd_default
 * @copyright   Copyright (c) 2014 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<?php   $resource = Mage::getSingleton('core/resource');
		$readConnection = $resource->getConnection('core_read');
		$table = $resource->getTableName('core_config_data');
		$divido_logo_query = "Select value from $table where path='payment/pay/logo'";	
		$divido_logo = $readConnection->fetchOne($divido_logo_query);
?>
<?php $divido = Mage::getModel('pay/standard'); ?>
<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_product = $this->getProduct(); ?>
<script type="text/javascript">
    var optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
</script>
<div id="messages_product_view"><?php echo $this->getMessagesBlock()->getGroupedHtml() ?></div>
<div class="product-view">
    <div class="product-essential">
        <form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
            <?php echo $this->getBlockHtml('formkey') ?>
            <div class="no-display">
                <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
                <input type="hidden" name="related_product" id="related-products-field" value="" />
            </div>

            <div class="product-img-box">
                <div class="product-name">
                    <h1><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></h1>
                </div>
                <?php echo $this->getChildHtml('media') ?>
            </div>

            <div class="product-shop">
                <div class="product-name">
                    <span class="h1"><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></span>
                </div>

                <div class="price-info">
                    <?php echo $this->getPriceHtml($_product); ?>
                    <?php echo $this->getChildHtml('bundle_prices') ?>
                    <?php echo $this->getTierPriceHtml() ?>
                </div>

                <div class="extra-info">
                    <?php echo $this->getReviewsSummaryHtml($_product, 'default', false)?>
                    <?php echo $this->getChildHtml('product_type_availability'); ?>
                </div>

                <?php echo $this->getChildHtml('alert_urls') ?>

                <?php if ($_product->getShortDescription()):?>
                    <div class="short-description">
                        <div class="std"><?php echo $_helper->productAttribute($_product, nl2br($_product->getShortDescription()), 'short_description') ?></div>
                    </div>
                <?php endif;?>
				<?php $currency_code = null; $currency_symbol = Mage::app()->getLocale()->currency( $currency_code )->getSymbol(); ?>
				<?php //$this->getLayout()->createBlock('core/template')->setTemplate('catalog/product/calculator.phtml')->toHtml(); ?>
				
			
			</div>
			 <?php echo $this->getChildHtml('other');?>

                <?php if ($_product->isSaleable() && $this->hasOptions()):?>
                    <?php echo $this->getChildChildHtml('container1', '', true, true) ?>
                <?php endif;?>

    

            <div class="add-to-cart-wrapper">
                <?php echo $this->getChildHtml('product_type_data') ?>
                <?php echo $this->getChildHtml('extrahint') ?>

                <?php if (!$this->hasOptions()):?>
                    <div class="add-to-box">
                        <?php if($_product->isSaleable()): ?>
                            <?php echo $this->getChildHtml('addtocart') ?>
                            <?php if( $this->helper('wishlist')->isAllow() || $_compareUrl=$this->helper('catalog/product_compare')->getAddUrl($_product)): ?>
                                <span class="or"><?php echo $this->__('OR') ?></span>
                            <?php endif; ?>
                        <?php endif; ?>
                        <?php echo $this->getChildHtml('addto') ?>
                        <?php echo $this->getChildHtml('sharing') ?>
                    </div>
                    <?php echo $this->getChildHtml('extra_buttons') ?>
                <?php elseif (!$_product->isSaleable()): ?>
                    <div class="add-to-box">
                        <?php echo $this->getChildHtml('addto') ?>
                        <?php echo $this->getChildHtml('sharing') ?>
                    </div>
                <?php endif; ?>
            </div>
			
            <?php echo $this->getChildHtml('related_products') ?>

            <div class="clearer"></div>
            <?php if ($_product->isSaleable() && $this->hasOptions()):?>
                <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
            <?php endif;?>
        </form>
	</div>
        <script type="text/javascript">
        //<![CDATA[
            var productAddToCartForm = new VarienForm('product_addtocart_form');
            productAddToCartForm.submit = function(button, url) {
                if (this.validator.validate()) {
                    var form = this.form;
                    var oldUrl = form.action;

                    if (url) {
                       form.action = url;
                    }
                    var e = null;
                    try {
                        this.form.submit();
                    } catch (e) {
                    }
                    this.form.action = oldUrl;
                    if (e) {
                        throw e;
                    }

                    if (button && button != 'undefined') {
                        button.disabled = true;
                    }
                }
            }.bind(productAddToCartForm);

            productAddToCartForm.submitLight = function(button, url){
                if(this.validator) {
                    var nv = Validation.methods;
                    delete Validation.methods['required-entry'];
                    delete Validation.methods['validate-one-required'];
                    delete Validation.methods['validate-one-required-by-name'];
                    // Remove custom datetime validators
                    for (var methodName in Validation.methods) {
                        if (methodName.match(/^validate-datetime-.*/i)) {
                            delete Validation.methods[methodName];
                        }
                    }

                    if (this.validator.validate()) {
                        if (url) {
                            this.form.action = url;
                        }
                        this.form.submit();
                    }
                    Object.extend(Validation.methods, nv);
                }
            }.bind(productAddToCartForm);
        //]]>
        </script>
    
	    <?php
			//add the customtab to the product tab
			$attribute = $_product->getResource()->getAttribute('divido');
			if(is_object($attribute))
			{
			  $identifier = $_product->getData("divido");
                         
                          
			}
		?>

	<?php if($identifier==5)
	{ ?>
	<div class="payment_box payment_method_divido" style="display: block;">			
        
            <fieldset style="background: none repeat scroll 0% 0% rgb(249, 249, 249); padding: 20px;">
                <img style="width:150px;float:right;margin-top:-5px;" src="<?php echo Mage::getBaseUrl('media').'/divido/'.$divido_logo; ?>">
                <h1><?php echo $this->__('Pay In Installments'); ?></h1>

                <div style="clear:both;"></div>

                <table style="width: 50%; float: left;">
                    <tbody>
                        <tr>
                            <td style="padding-bottom: 15px;">
                                <label for="divido_campaign"><b>We offer a wide range of finance options:</b></label><br>
                                <select style="width:250px; padding: 4px 0px" id="divido_campaign123" name="divido_campaign123">
                                    <?php /*if ($this->getCampaign()->status == 'ok') {
                                                foreach($this->getCampaign()->campaigns as $campaign) {
                                                    print '<option value="'.$campaign->code.'">'.$campaign->text.' ('.$campaign->interest_rate.'% APR)</option>';
                                                }
                                            }*/ ?>
                                </select>
                            </td>
						</tr>
						<tr>
                            <td>
                                <label for="divido_deposit_percent">Use the slider below to set your deposit amount:</label>

                                <div id="slider-margin" style="width:250px; padding: 10px 0px;">
                                    <div style="width:50px;float:left;">
                                            <span class="divido_deposit_percent">15</span> %
                                    </div>
                                    <div style="width:180px;margin-left:10px;float:left;">
                                        <div class="divido_slider"></div>
                                        <input type="hidden" id="divido_deposit_percent" name="divido_deposit" value="15.00">
                                    </div>
                                </div>
                            </td>
                       </tr>
                   </tbody>
                </table>
                <div class="clear"></div>

                <div style="background:#f9f9f9;padding:0px;">
                    <table style="width: 50%;">
                        <tbody>
                            <tr>
								<td>
									<b><span class="divido_agreement_duration">6</span> Monthly Payments of</b>
								</td>
							</tr>
							<tr>
								<td style="font-size:24px;padding:10px">
                                      <?php echo $currency_symbol; ?> <span class="divido_monthly_payment_amount"></span>
                                </td>
							</tr>
							<tr>
								<td style="font-size: 24px;">
									<b>Interest <span class="divido_apr_percent_text">0</span></b>
								</td>
							</tr>
							<tr>
								<td>
									Duration of Agreement
								</td>
								<td>
									<span class="divido_agreement_duration">6</span> Months
								</td>
							</tr>
							<tr>
                                <td>
                                      Monthly Instalment
                                </td>
                                <td>
                                      <?php echo $currency_symbol; ?> <span class="divido_monthly_payment_amount"></span>
                                </td>
                            </tr>
							<tr>
                                <td>
                                      Deposit
                                </td>
                                <td>
									<?php echo $currency_symbol; ?> <span class="divido_deposit_amount"></span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                      Amount of Credit
                                </td>
                                <td>
									<?php echo $currency_symbol; ?> <span class="divido_total_repayable_amount"><?php echo $_product->getPrice(); // this will return total price of items added in the  shopping cart. ?></span>
                                </td>
                            </tr>
							<tr>
                                <td>
                                      Total Repayable
                                </td>
                                <td>
									<?php echo $currency_symbol; ?> <span class="divido_total_repayable_amount"><?php echo $_product->getPrice(); // this will return total price of items added in the  shopping cart. ?></span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                     Total Interest APR
                                </td>
                                <td>
                                      <span class="divido_apr_representative_percent">0</span>%
                                </td>
                           </tr>
                        </tbody>
                    </table>
                </div>

                <div class="clear"></div>
                
				<?php //echo $this->getCampaign()->status; ?>
            </fieldset>
            <?php   $divido_campaigns = array(); 
                    if ($divido->getCampaign()->status == 'ok') {
                        foreach($divido->getCampaign()->campaigns as $campaign) {
                                $divido_campaigns[] = array("code"=> $campaign->code, "country"=> $campaign->country, "text"=> $campaign->text, "interest_rate"=> $campaign->interest_rate, "min_amount"=> $campaign->min_amount, "agreement_duration"=> $campaign->agreement_duration, "deferral_period"=> $campaign->deferral_period);
                        }
                    }  ?>
					<?php //echo "<pre>"; print_r($divido_campaigns); echo "</pre>"; die('this'); ?>
    <script>
	jQuery(document).ready(function($) {

           $.divido_campaigns = $.parseJSON('<?php echo json_encode($divido_campaigns); ?>');
	    /* $.divido_campaigns = [{"code":"01","country":"GB","text":"6 Months 0% Interest Free","interest_rate":0,"min_amount":500,"agreement_duration":6,"deferral_period":0},{"code":"02","country":"GB","text":"9 Months 0% Interest Free","interest_rate":0,"min_amount":500,"agreement_duration":9,"deferral_period":0},{"code":"03","country":"GB","text":"12 Months 0% Interest Free","interest_rate":0,"min_amount":500,"agreement_duration":12,"deferral_period":0},{"code":"04","country":"GB","text":"24 Months 0% Interest Free","interest_rate":0,"min_amount":500,"agreement_duration":24,"deferral_period":0},{"code":"05","country":"GB","text":"36 Months 0% Interest Free","interest_rate":0,"min_amount":500,"agreement_duration":36,"deferral_period":0},{"code":"06","country":"GB","text":"12 Months 9.50% APR","interest_rate":9.5,"min_amount":500,"agreement_duration":12,"deferral_period":0},{"code":"07","country":"GB","text":"Pay in 12 Months","interest_rate":26.4,"min_amount":500,"agreement_duration":48,"deferral_period":12}]; */
		$.divido_amount = jQuery('.divido_total_repayable_amount').html();

		$("#divido_campaign").html('');

		$.each($.divido_campaigns,function(i,campaign) {
			//var drop_val = parseInt(i)+parseInt(1);
			var option = $("<option>").html(campaign.text).val(i);
			$("#divido_campaign").append(option);
			
		});

		$.divido_calculator_month = 111;
		$.divido_monthly_payment_amount = 222;
		$.divido_apr_representative_text = 'free 0%';
		$.divido_apr_representative_percent = 0;
		$.divido_deposit_amount = 0;
		$.divido_deposit_percent = 10;

                $.divido_credit_amount = 555;
                $.divido_total_repayable_amount = jQuery('.divido_total_repayable_amount').html();		

		divido_changePlan();
		divido_recalculate();

		var sliders = $('.divido_slider').noUiSlider({
			start: [ 10 ],
			step: 5,
			range: {
				'min': [  5 ],
				'max': [ 50 ]
			},
		});
                sliders.on("slide", function() {
                      var value = parseInt($( this ).val());
                      jQuery("span.divido_deposit_percent,div.divido_deposit_percent").html(value);
			jQuery("input#divido_deposit_percent").val(value);
                        divido_changeDeposit();
                    });

		jQuery("select#divido_campaign").change(function(){
                    var divido_campaign = $.divido_campaigns[jQuery("#divido_campaign").val()];
			$.divido_apr_representative_percent = divido_campaign.interest_rate;
			$.divido_agreement_duration = divido_campaign.agreement_duration;
									
			if ($.divido_apr_representative_percent > 0) {
				$.divido_apr_representative_text = 'APR '+$.divido_apr_representative_percent+'%';
			} else {
				$.divido_apr_representative_text = 'free 0%';
			}
			divido_recalculate();
                });

		function divido_changePlan() {
			var divido_campaign = $.divido_campaigns[jQuery("#divido_campaign").val()];
			$.divido_apr_representative_percent = divido_campaign.interest_rate;
			$.divido_agreement_duration = divido_campaign.agreement_duration;
									
			if ($.divido_apr_representative_percent > 0) {
				$.divido_apr_representative_text = 'APR '+$.divido_apr_representative_percent+'%';
			} else {
				$.divido_apr_representative_text = 'free 0%';
			}
			divido_recalculate();
		}

		function divido_changeDeposit()
		{
 			$.divido_deposit_percent = parseFloat($("#divido_deposit_percent").val());
			divido_recalculate();	
		}

		function divido_recalculate() {
			console.log('divido_deposit_percent: '+$.divido_deposit_percent);
			console.log('divido_amount: '+$.divido_amount);
			console.log('divido_deposit_amount: '+$.divido_deposit_amount);
			console.log('divido_credit_amount: '+$.divido_credit_amount);

			$.divido_deposit_amount = parseFloat(($.divido_deposit_percent/100) * $.divido_amount).toFixed(2);
			$.divido_credit_amount = parseFloat($.divido_amount - $.divido_deposit_amount).toFixed(2);
			$.divido_monthly_payment_amount = parseFloat($.divido_credit_amount / $.divido_agreement_duration).toFixed(2);
			$.divido_finance_cost = parseFloat($.divido_credit_amount*($.divido_apr_representative_percent/100)).toFixed(2);
			$.divido_total_repayable_amount = parseFloat($.divido_credit_amount + $.divido_finance_cost).toFixed(2);
			
			jQuery("span.divido_agreement_duration,div.divido_agreement_duration").html($.divido_agreement_duration);
			jQuery("input.divido_agreement_duration").val($.divido_agreement_duration);

			jQuery("span.divido_monthly_payment_amount,div.divido_monthly_payment_amount").html($.divido_monthly_payment_amount);
			jQuery("input.divido_monthly_payment_amount").val($.divido_monthly_payment_amount);

			jQuery("span.divido_apr_representative_text,div.divido_apr_representative_text").html($.divido_apr_representative_text);
			jQuery("input.divido_apr_representative_text").val($.divido_apr_representative_text);
			jQuery("span.divido_apr_percent_text").html($.divido_apr_representative_text);

			jQuery("span.divido_apr_representative_percent,div.divido_apr_representative_percent").html($.divido_apr_representative_percent);
			jQuery("input.divido_apr_representative_percent").val($.divido_apr_representative_percent);

			jQuery("span.divido_deposit_amount,div.divido_deposit_amount").html($.divido_deposit_amount);
			jQuery("input.divido_deposit_amount").val($.divido_deposit_amount);

			jQuery("span.divido_deposit_percent,div.divido_deposit_percent").html($.divido_deposit_percent);
			jQuery("input#divido_deposit_percent").val($.divido_deposit_percent);

			jQuery("span.divido_credit_amount,div.divido_credit_amount").html($.divido_credit_amount);
			jQuery("input.divido_credit_amount").val($.divido_credit_amount);

			jQuery("span.divido_total_repayable_amount,div.divido_total_repayable_amount").html($.divido_total_repayable_amount);
			jQuery("input.divido_total_repayable_amount").val($.divido_total_repayable_amount);
		}
	});
	</script>
	</div>
	<?php } ?>
    <div class="product-collateral toggle-content tabs">
        <?php if ($detailedInfoGroup = $this->getChildGroup('detailed_info', 'getChildHtml')):?>
            <dl id="collateral-tabs" class="collateral-tabs">
                <?php foreach ($detailedInfoGroup as $alias => $html):?>
                    <dt class="tab"><span><?php echo $this->escapeHtml($this->getChildData($alias, 'title')) ?></span></dt>
                    <dd class="tab-container">
                        <div class="tab-content"><?php echo $html ?></div>
                    </dd>
                <?php endforeach;?>
            </dl>
        <?php endif; ?>
    </div>

    <?php echo $this->getChildHtml('upsell_products') ?>
    <?php echo $this->getChildHtml('product_additional_data') ?>

</div>



